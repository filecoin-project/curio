name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '**'

env:
  GO_VERSION: 1.24.7

jobs:
  ci-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: ./.github/actions/setup-go
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install actionlint
        run: go install github.com/rhysd/actionlint/cmd/actionlint

      - name: Run actionlint
        run: actionlint -shellcheck= -pyflakes=

  # Build FFI (filecoin-ffi) - rarely changes, heavily cached
  # Go modules are cached separately via setup-go action (based on go.sum)
  build-ffi:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          go-version: ${{ env.GO_VERSION }}
          download-ffi: 'false'

      - name: Generate FFI cache key
        id: ffi-cache-key
        run: |
          FFI_COMMIT=$(git -C extern/filecoin-ffi rev-parse HEAD)
          echo "key=ffi-${{ runner.os }}-${{ env.GO_VERSION }}-${FFI_COMMIT}" >> $GITHUB_OUTPUT

      - name: Cache FFI build
        id: cache-ffi
        uses: actions/cache@v4
        with:
          path: |
            extern/filecoin-ffi/.install-filcrypto
            extern/filecoin-ffi/filcrypto.h
            extern/filecoin-ffi/libfilcrypto.a
            extern/filecoin-ffi/filcrypto.pc
            build/.filecoin-install
            build/.blst-install
            extern/supraseal/.install-blst
            extern/supraseal/deps/blst
          key: ${{ steps.ffi-cache-key.outputs.key }}

      - name: Build FFI
        if: steps.cache-ffi.outputs.cache-hit != 'true'
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: make deps

      - name: Upload FFI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffi-deps
          path: |
            extern/filecoin-ffi/.install-filcrypto
            extern/filecoin-ffi/filcrypto.h
            extern/filecoin-ffi/libfilcrypto.a
            extern/filecoin-ffi/filcrypto.pc
            build/.filecoin-install
            build/.blst-install
            extern/supraseal/.install-blst
            extern/supraseal/deps/blst
          retention-days: 3

  setup-params:
    runs-on: [self-hosted, docker]
    steps:
      - name: Cache proof parameters
        uses: actions/cache@v4
        with:
          path: /var/tmp/filecoin-proof-parameters
          key: proof-params-8388608

      - name: Fetch parameters
        run: lotus fetch-params 8388608
        shell: bash

  # Debug build - separate so tests can depend on it without waiting for other variants
  build-debug:
    runs-on: ubuntu-latest
    needs: [build-ffi]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build debug
        run: make debug

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-debug
          path: |
            curio
            sptool
          retention-days: 1

  # Other build variants - run in parallel, tests don't wait for these
  build:
    runs-on: ubuntu-latest
    needs: [build-ffi]
    strategy:
      fail-fast: false
      matrix:
        variant:
          - name: mainnet
            target: build
          - name: calibnet
            target: calibnet
          - name: 2k
            target: 2k
          - name: forest
            target: forest-test
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build ${{ matrix.variant.name }}
        run: make ${{ matrix.variant.target }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.variant.name }}
          path: |
            curio
            sptool
          retention-days: 1

  # Unit tests - no database needed
  test-unit:
    runs-on: [self-hosted, docker]
    needs: [build-debug, setup-params]
    container:
      image: ghcr.io/${{ github.repository }}/build-env:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      volumes:
        - /var/tmp/filecoin-proof-parameters:/var/tmp/filecoin-proof-parameters
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download FFI artifacts
        uses: actions/download-artifact@v4
        with:
          name: ffi-deps
          path: .

      - name: Download debug binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-debug
          path: .

      - name: Make binaries executable
        run: chmod +x curio sptool || true

      - name: Run unit tests
        run: go test -v --tags=debug -timeout 30m `go list ./... | grep -v curio/itests`

  # Integration tests - need YugabyteDB
  # Note: Cannot use job container because we need Docker access to run YugabyteDB
  test-itest:
    runs-on: [self-hosted, docker]
    needs: [build-debug, setup-params]
    env:
      CONTAINER_NAME: yugabyte-${{ github.run_id }}-${{ matrix.test-suite.name }}
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - name: itest-curio
            target: "./itests/curio_test.go"
          - name: itest-harmonyDB
            target: "./itests/harmonydb_test.go"
          - name: itest-alertnow
            target: "./itests/alertnow_test.go"
          - name: itest-pdp-prove
            target: "./itests/pdp_prove_test.go"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download debug binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-debug
          path: .

      - name: Make binaries executable
        run: chmod +x curio sptool || true

      - name: Start YugabyteDB container
        run: |
          docker run --rm --name ${{ env.CONTAINER_NAME }} -d yugabytedb/yugabyte:2024.1.2.0-b77 bin/yugabyted start --daemon=false

      - name: Wait for YugabyteDB to start
        run: |
          while true; do
            status=$(docker exec ${{ env.CONTAINER_NAME }} bin/yugabyted status);
            echo $status;
            echo $status | grep Running && break;
            sleep 1;
          done

      - name: Get YugabyteDB container IP
        id: get-yb-ip
        run: |
          YB_IP=$(docker inspect $CONTAINER_NAME --format '{{ .NetworkSettings.Networks.bridge.IPAddress }}')
          echo "yb_ip=$YB_IP" >> $GITHUB_OUTPUT

      - name: Run integration tests
        env:
          CURIO_HARMONYDB_HOSTS: ${{ steps.get-yb-ip.outputs.yb_ip }}
          LOTUS_HARMONYDB_HOSTS: ${{ steps.get-yb-ip.outputs.yb_ip }}
        run: |
          echo "Using YugabyteDB Container IP: ${{ env.CURIO_HARMONYDB_HOSTS }}"
          go test -v --tags=debug -timeout 30m ${{ matrix.test-suite.target }}

      - name: Stop YugabyteDB container
        if: always()
        run: docker stop ${{ env.CONTAINER_NAME }}

  lint:
    runs-on: ubuntu-latest
    needs: [build-ffi]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v2.4.0
        shell: bash

      - name: Lint
        run: |
          golangci-lint run -v --timeout 15m --concurrency 4
        shell: bash

  gofmt:
    runs-on: ubuntu-latest
    needs: [ci-lint]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: ./.github/actions/setup-go
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check gofmt
        run: go fmt ./...
        shell: bash

      - name: Git diff check
        run: git --no-pager diff
        shell: bash

      - name: Git diff quiet
        run: git --no-pager diff --quiet
        shell: bash

  build-supraseal-ubuntu24:
    runs-on: ubuntu-24.04
    needs: [ci-lint]
    env:
      GCC_VERSION: "12"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free up disk space
        run: |
          sudo apt-get clean
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc-12 g++-12 \
            nasm \
            pkg-config \
            autoconf automake libtool \
            libssl-dev \
            libnuma-dev \
            uuid-dev \
            libaio-dev \
            libfuse3-dev \
            libarchive-dev \
            libkeyutils-dev \
            libncurses-dev \
            python3 python3-pip python3-dev \
            curl wget git \
            xxd

      - name: Set up Python virtual environment
        run: |
          python3 -m venv --help > /dev/null || sudo apt-get install -y python3-venv

      - name: Set up GCC 12 as default
        run: |
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100
          sudo update-alternatives --set gcc /usr/bin/gcc-12
          sudo update-alternatives --set g++ /usr/bin/g++-12
          gcc --version
          g++ --version

      - name: Cache CUDA installation
        id: cache-cuda
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/cuda
            /usr/local/cuda-*
          key: cuda-toolkit-ubuntu-24.04-${{ runner.os }}-v1

      - name: Install CUDA Toolkit from NVIDIA Repository
        if: steps.cache-cuda.outputs.cache-hit != 'true'
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          rm cuda-keyring_1.1-1_all.deb
          
          sudo apt-get update
          sudo apt-get -y install cuda-toolkit
          
          if [ -d "/usr/local/cuda" ]; then
            echo "CUDA installed at /usr/local/cuda"
            ls -la /usr/local/cuda*/bin/nvcc || true
          else
            echo "ERROR: CUDA installation not found"
            exit 1
          fi

      - name: Set up CUDA environment
        run: |
          # Verify CUDA installation exists
          if [ ! -d "/usr/local/cuda" ]; then
            echo "ERROR: /usr/local/cuda not found"
            exit 1
          fi
          
          # Export PATH locally to verify nvcc works
          export PATH="/usr/local/cuda/bin:$PATH"
          export CUDA_HOME=/usr/local/cuda
          export LD_LIBRARY_PATH="/usr/local/cuda/lib64:${LD_LIBRARY_PATH}"
          
          nvcc --version
          
          echo "/usr/local/cuda/bin" >> $GITHUB_PATH
          echo "CUDA_HOME=/usr/local/cuda" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Install libconfig++
        run: |
          sudo apt-get install -y libconfig++-dev || {
            wget https://hyperrealm.github.io/libconfig/dist/libconfig-1.7.3.tar.gz
            tar -xzf libconfig-1.7.3.tar.gz
            cd libconfig-1.7.3
            ./configure
            make -j$(nproc)
            sudo make install
            sudo ldconfig
            cd ..
            rm -rf libconfig-1.7.3*
          }

      - name: Install GMP library
        run: sudo apt-get install -y libgmp-dev

      - name: Cache Python venv
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: extern/supraseal/.venv
          key: supraseal-venv-ubuntu24-${{ hashFiles('extern/supraseal/build.sh') }}
          restore-keys: |
            supraseal-venv-ubuntu24-

      - name: Cache SPDK build
        id: cache-spdk
        uses: actions/cache@v4
        with:
          path: extern/supraseal/deps/spdk-v24.05
          key: spdk-v24.05-gcc12-ubuntu24-${{ hashFiles('extern/supraseal/build.sh') }}
          restore-keys: |
            spdk-v24.05-gcc12-ubuntu24-

      - name: Build Supraseal
        working-directory: extern/supraseal
        run: |
          export CC=gcc-12
          export CXX=g++-12
          export CUDA=/usr/local/cuda
          export PATH=/usr/local/cuda/bin:$PATH
          export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
          
          which nvcc
          nvcc --version
          
          ./build.sh

      - name: Verify binaries
        working-directory: extern/supraseal
        run: |
          echo "=== Built binaries ==="
          ls -lh bin/
          
          echo ""
          echo "=== Verifying binaries exist ==="
          test -f bin/seal && echo "âœ“ seal binary created" || exit 1
          test -f bin/pc2 && echo "âœ“ pc2 binary created" || exit 1
          test -f bin/tree_r && echo "âœ“ tree_r binary created" || exit 1
          test -f bin/tree_r_cpu && echo "âœ“ tree_r_cpu binary created" || exit 1
          test -f bin/tree_d_cpu && echo "âœ“ tree_d_cpu binary created" || exit 1
          
          echo ""
          echo "=== Binary sizes ==="
          du -h bin/*
          
          echo ""
          echo "âœ… All binaries built successfully!"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: supraseal-binaries-ubuntu24-gcc12-cuda
          path: |
            extern/supraseal/bin/seal
            extern/supraseal/bin/pc2
            extern/supraseal/bin/tree_r
            extern/supraseal/bin/tree_r_cpu
            extern/supraseal/bin/tree_d_cpu
          retention-days: 30

      - name: Upload library artifact
        uses: actions/upload-artifact@v4
        with:
          name: supraseal-library-ubuntu24-gcc12-cuda
          path: extern/supraseal/obj/libsupraseal.a
          retention-days: 30

      - name: Build summary
        run: |
          echo "### ðŸŽ‰ Supraseal Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- OS: Ubuntu 24.04" >> $GITHUB_STEP_SUMMARY
          echo "- GCC: $(gcc --version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- CUDA: $(nvcc --version | grep release)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Built Binaries:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh extern/supraseal/bin/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All binaries compiled successfully with GCC 12 and CUDA!" >> $GITHUB_STEP_SUMMARY

  gen-check:
    runs-on: ubuntu-latest
    needs: [build-ffi]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install Go tools
        run: |
          # Tools are defined in tools/tools.go and versioned in go.mod
          go install golang.org/x/tools/cmd/goimports &
          go install github.com/hannahhoward/cbor-gen-for &
          go install github.com/swaggo/swag/cmd/swag &
          wait
        shell: bash

      - name: Generate Code
        env:
          LANG: en-US
        run: make gen
        shell: bash

      - name: Git diff check
        run: git --no-pager diff
        shell: bash

      - name: Git diff quiet
        run: git --no-pager diff --quiet
        shell: bash

  mod-tidy-check:
    runs-on: ubuntu-latest
    needs: [ci-lint]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: ./.github/actions/setup-go
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install Dependencies
        uses: ./.github/actions/install-deps

      - name: Run mod tidy check
        run: go mod tidy -v
        shell: bash
