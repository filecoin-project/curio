<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">

<head>
  <title>Sector List</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  <script type="module" src="/ux/curio-ux.mjs"></script>
  <script type="module">
    import('../lib/jsonrpc.mjs').then(module => {
      window.RPCCall = module.default;

      const event = new CustomEvent('RPCCallReady');
      window.dispatchEvent(event);
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.min.css" />
  <script src="https://cdn.datatables.net/2.0.2/js/dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.bootstrap5.min.css" />

  <link rel="stylesheet" href="https://cdn.datatables.net/scroller/2.4.1/css/scroller.dataTables.min.css" />
  <script src="https://cdn.datatables.net/scroller/2.4.1/js/dataTables.scroller.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.1/css/responsive.dataTables.min.css" />
  <script src="https://cdn.datatables.net/responsive/3.0.1/js/dataTables.responsive.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.1/css/buttons.dataTables.min.css" />
  <script src="https://cdn.datatables.net/buttons/3.0.1/js/dataTables.buttons.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/select/2.0.0/css/select.dataTables.min.css" />
  <script src="https://cdn.datatables.net/select/2.0.0/js/dataTables.select.min.js"></script>
</head>

<body style="visibility:hidden" data-bs-theme="dark">
  <curio-ux>
    <section class="section container-fluid">
      <div class="row justify-content-center content">
        <div class="col-md-auto" style="max-width: 95%">
          <table id="sectorTable" class="hover">
            <tr>
              <td>Loading...</td>
            </tr>
          </table>
        </div>
      </div>
    </section>
  </curio-ux>
  <script>
    //import RPCCall from '../lib/jsonrpc.mjs';
    // Function to get a cookie value
    function getCookie(cname) {
      let name = cname + "=";
      let ca = document.cookie.split(';');
      for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

    // Function to set a cookie value
    function setCookie(cname, cvalue, exdays) {
      let d = new Date();
      d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
      let expires = "expires="+d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    // Function to add a parameter to a URL
    function addParamToUrl(url, param, paramVal){
      let _url = new URL(url);
      _url.searchParams.append(param, paramVal);
      return _url;
    }

    // Retrieve the current cookie value
    let cookieValue = getCookie("curioStorageCookie");

    // If the cookie value exists, append it as a query parameter to the AJAX URL
    let ajaxUrl = '/api/sector/all';
    if (cookieValue){
      ajaxUrl = addParamToUrl(ajaxUrl, "miner", cookieValue);
    }


    let dt = new DataTable('#sectorTable', {
      ajax: '/api/sector/all',
      columns: [
        {title: "", data: null},
        {title: "SpID", data:'MinerID'},
        {title: "Sector", data: 'SectorNum', render: function(data, type, row) {
          if (type === 'display') {
            return `<a href="/pages/sector/?sp=${row.MinerID}&id=${data}">${data}</a>`;
          }
          return data;
        }},
        {title: "Expiry", data:'ExpiresAt'},
        {title: "ðŸ”—", data:'IsOnChain'},
        {title: "Proving", data:'Proving'},
        {title: "Has Sealed", data:'HasSealed'},
        {title: "Has Unsealed", data:'HasUnsealed'},
        {title: "DealWeight", data:"DealWeight"},
        {title: "Deals", data:"Deals"},
        {title: "Fil+", data:'IsFilPlus'},
        {title: "Has Snap", data:'HasSnap'},
        {title: "Size", data:"SealInfo"},
        {title: "Flag", data:"Flag"}
      ],
      layout: {
        topStart: 'buttons',
        bottomStart: 'info',
      },
      buttons: [
        {
            extend: 'copy',
            text: 'ðŸ“‹'
        },
        'csv',
        {
            extend: 'selected',
            text: 'Terminate & Delete',
            action: function (e, dt, button, config) {
              var res = dt.rows({ selected: true }).data().toArray().map(function (row) {
                return {MinerID: row.MinerID, Sector: row.SectorNum};
              });
              console.log(res);
              var confirmMessage = res.map(obj => `SpID: ${obj.MinerID}, Sector: ${obj.Sector}`).join(", ");

              if (confirm("Terminate & Delete: "+confirmMessage)) {
                axios.post('/api/sector/terminate', res)
                  .then(function (response) {
                    console.log(response);
                    document.cookie = "sector_refresh=true; path=/";
                    location.reload();
                  })
                  .catch(function (error) {
                    console.log(error);
                  });
              }
            }
        },
        {
            text: 'Refresh',
            action: function (e, dt, button, config) {
              document.cookie = "sector_refresh=true; path=/";
              location.reload();
            }
        },
        {
          text: 'Select Miners',
          action: function (e, dt, button, config) {
            var selectedOptions = $("#selectOptions").val();
            if(selectedOptions.length > 0){
              setCookie("curioStorageCookie", selectedOptions.join(','), 7);
              location.reload();
            }
          },
          init: async function (dt, node, config) {
            var selectOptions = $('<select id="selectOptions" multiple>').css({marginRight: '5px'});

            let RPCCallInterval = setInterval(function() {
              if (window.RPCCall) {
                clearInterval(RPCCallInterval);
                window.RPCCall('ActorList').then(actors => {
                  if(Array.isArray(actors)) {
                    actors.forEach(function (actor) {
                      selectOptions.append($("<option>").attr('miner', actor.value).text(actor.text));
                    });
                  } else {
                    console.error('Expected an array but got:', actors);
                  }
                });
              }
            }, 200);

            // if (window.RPCCall) {
            //   clearInterval(RPCCallInterval);
            //   window.RPCCall('ActorList').then(actors => {
            //     console.log(actors)
            //     if(Array.isArray(actors)) {
            //       actors.forEach(function (actor) {
            //         selectOptions.append($("<option>").attr('value', actor.value).text(actor.text));
            //       });
            //     } else {
            //       console.error('Expected an array but got:', actors);
            //     }
            //   }).catch(error => console.error('Error:', error));
            // }


            // RPCCall to get actors
            // let actors = RPCCall('ActorList');
            // if(Array.isArray(actors)) {
            //   actors.forEach(function (actor) {
            //     selectOptions.append($("<option>").attr('value', actor.value).text(actor.text));
            //   });
            // } else {
            //   console.error('Expected an array but got:', actors);
            // }

            $(node).prepend(selectOptions);
          }
        },
      ],
      responsive: true,
      columnDefs: [
          {
              orderable: false,
              render: DataTable.render.select(),
              targets: 0
          },
          {
              targets: 13,
              visible: false, // Make the "Flag" column hidden
              searchable: false,
          }
      ],
      order: [[13, 'desc'], [1, 'asc'], [2, 'asc']],
      select: {
        style: 'multi',
        selector: 'td:first-child',
        items: 'row',
        rows: '%d rows selected',
        headerCheckbox: true,
      },
      scrollY:        window.innerHeight - 250,
      deferRender:    true,
      scroller:       true,
    });
  </script>
</body>

</html>