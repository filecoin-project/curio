# Dockerfile for testing Supraseal build locally
# Mimics the GitHub Actions Ubuntu 24.04 environment

FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV GCC_VERSION=12

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc-12 g++-12 \
    nasm \
    pkg-config \
    autoconf automake libtool \
    libssl-dev \
    libnuma-dev \
    uuid-dev \
    libaio-dev \
    libfuse3-dev \
    libarchive-dev \
    libkeyutils-dev \
    libncurses-dev \
    python3 python3-pip python3-dev \
    curl wget git \
    xxd \
    libconfig++-dev \
    libgmp-dev \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Set up GCC 12 as default
RUN update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100 && \
    update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100 && \
    update-alternatives --set gcc /usr/bin/gcc-12 && \
    update-alternatives --set g++ /usr/bin/g++-12

# Install CUDA Toolkit from NVIDIA Repository
# Source: https://developer.nvidia.com/cuda-downloads?target_os=Linux&target_arch=x86_64&Distribution=Ubuntu&target_version=24.04&target_type=deb_local
RUN wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb && \
    dpkg -i cuda-keyring_1.1-1_all.deb && \
    rm cuda-keyring_1.1-1_all.deb && \
    apt-get update && \
    apt-get -y install cuda-toolkit && \
    rm -rf /var/lib/apt/lists/*

# Set up CUDA environment and verify installation
ENV PATH=/usr/local/cuda/bin:${PATH}
ENV CUDA_HOME=/usr/local/cuda
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64

# Verify CUDA installation and version
RUN nvcc --version && \
    CUDA_VERSION=$(nvcc --version | grep "release" | sed -n 's/.*release \([0-9]*\)\.\([0-9]*\).*/\1/p') && \
    echo "Installed CUDA version: $CUDA_VERSION" && \
    if [ "$CUDA_VERSION" -lt 12 ]; then \
        echo "ERROR: CUDA $CUDA_VERSION is too old. Need CUDA 12 or newer."; \
        exit 1; \
    fi

# Set working directory
WORKDIR /workspace

# Default command
CMD ["/bin/bash"]

