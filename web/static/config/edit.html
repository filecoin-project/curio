<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <title>JSON Schema Editor</title>
    <script type="module" src="/ux/curio-ux.mjs"></script>
    <script type="module" src="/ux/components/Drawer.mjs"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@2.14.0/dist/jsoneditor.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/ui-darkness/jquery-ui.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/ui-darkness/theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body style="visibility: hidden;">
    <style>
        #saveButton {
            display: block;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            font-size: 18px;
            border: none;
            outline: none;
            background-color: green;
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 4px;
        }

        #saveButton:hover {
            background-color: #555;
        }

        #historyButton {
            display: block;
            position: fixed;
            bottom: 80px;
            right: 30px;
            z-index: 99;
            font-size: 14px;
            border: none;
            outline: none;
            background-color: #495057;
            color: white;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 4px;
        }

        #historyButton:hover {
            background-color: #6c757d;
        }

        .help-button button {
            font-size: 24px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            position: fixed;
            bottom: 20px;
            right: 120px;
            z-index: 99;
        }

        .help-text {
            display: none;
            position: fixed;
            border: 1px solid #ccc;
            background-color: gray;
            padding: 10px;
            width: 200px;
            bottom: 20px;
            right: 200px;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #historyModal .modal-dialog {
            max-width: 90%;
        }

        #historyModal .modal-body {
            max-height: 75vh;
            overflow-y: auto;
        }

        .history-list-item {
            cursor: pointer;
            padding: 8px 12px;
            border-bottom: 1px solid #333;
        }

        .history-list-item:hover {
            background-color: #2a2a2a;
        }

        .diff-container {
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .diff-line-add {
            background-color: rgba(46, 160, 67, 0.2);
            color: #3fb950;
        }

        .diff-line-remove {
            background-color: rgba(248, 81, 73, 0.2);
            color: #f85149;
        }

        .diff-line-context {
            color: #8b949e;
        }

        .hidden {
            display: none;
        }

        .show {
            display: block;
        }

        /* Fix for dark mode */
        .card.bg-light {
            background-color: rgb(11, 22, 34) !important;
        }
        input.form-control {
            background: #111;
            color: white;
            font-weight: bold;
        }

        /* Hide the info button tooltips */
        .jsoneditor-twbs5-text-button[data-toggle="tooltip"] {
            display: none !important;
        }
        
        /* Style for field descriptions that we'll inject */
        .field-description {
            display: block;
            color: #aaa;
            font-size: 0.875rem;
            margin-top: 4px;
            margin-bottom: 8px;
            font-style: italic;
            line-height: 1.4;
            max-width: 100%;
            white-space: pre-wrap;
        }
    </style>
    <curio-ux>
        <section class="section container-fluid implementations">
            <div class="row justify-content-center content">
                <div class="col-md-8">
                    <div>
                        <button id="saveButton" class="saveButton">Save</button>
                        <button id="historyButton">&#128337; History</button>
                    </div>

                    <!-- History Modal -->
                    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content bg-dark">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="historyModalLabel">Config History</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="historyListView">
                                        <p class="text-muted">Loading history...</p>
                                    </div>
                                    <div id="historyDiffView" style="display:none;">
                                        <button class="btn btn-sm btn-outline-secondary mb-3" id="backToHistoryList">&larr; Back to list</button>
                                        <h6 id="diffTitle" class="text-muted mb-3"></h6>
                                        <div class="diff-container bg-black p-3 rounded" id="diffOutput"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="help-button">
                        <button id="helpBtn">?</button>
                        <p id="helpText" class="hidden help-text">Checking a box and entering a non default value will uncomment the corresponding configuration variable.
                            Unchecking a box will reset the value to default.</p>
                    </div>

                    <div id="editor" data-bs-theme="dark"></div>
                    <script>
                        var editor;
                        var urlParams = new URLSearchParams(window.location.search);
                        var layer = urlParams.get('layer');
                        // Make simultaneous GET requests to fetch the existing data and JSON Schema
                        const layerPath = layer === 'default' ? 'config/default' : `config/layers/${layer}`;
                        Promise.all([
                            axios.get(`/api/${layerPath}`),
                            axios.get('/api/config/schema')
                        ])
                            .then(responses => {
                                const existingData = responses[0].data;
                                const schema = responses[1].data;

                                // Create a JSON Editor instance and pass the schema and existing data
                                const container = document.getElementById('editor');
                                const options = {
                                    mode: 'tree',
                                    schema: schema,
                                    startval: existingData,
                                    theme: 'bootstrap5',
                                    iconlib: 'jqueryui',
                                    show_opt_in: true,
                                    disable_edit_json: true,
                                    form_name_root: "Configuration",
                                    disable_properties: true,
                                    show_errors: "always",
                                    display_required_only: false,
                                    remove_button_labels: false,
                                };

                                editor = new JSONEditor(container, options);

                                // Function to convert tooltip buttons to visible descriptions
                                function showDescriptions() {
                                    const infoButtons = document.querySelectorAll('.jsoneditor-twbs5-text-button[data-toggle="tooltip"]');
                                    infoButtons.forEach(button => {
                                        // Bootstrap 5 moves title to data-bs-original-title
                                        const description = button.getAttribute('data-bs-original-title') || button.getAttribute('title');
                                        if (description) {
                                            // Create a description div
                                            const descDiv = document.createElement('div');
                                            descDiv.className = 'field-description';
                                            descDiv.textContent = description.replace(/&quot;/g, '"');
                                            
                                            // Find the parent form group and insert description
                                            let parent = button.closest('.form-group');
                                            if (!parent) {
                                                parent = button.closest('.card-body');
                                            }
                                            if (!parent) {
                                                parent = button.parentElement;
                                            }
                                            
                                            // Check if description hasn't been added already
                                            if (parent && !parent.querySelector('.field-description')) {
                                                parent.appendChild(descDiv);
                                            }
                                        }
                                    });
                                }

                                // Call after editor is ready and on any changes
                                editor.on('ready', function() {
                                    showDescriptions();
                                });
                                
                                // Re-run when editor changes (for dynamic fields)
                                editor.on('change', function() {
                                    setTimeout(showDescriptions, 100);
                                });

                                document.getElementById("helpBtn").addEventListener("click", function() {
                                    var helpText = document.getElementById("helpText");
                                    if (helpText.classList.contains("hidden")) {
                                        helpText.classList.remove("hidden");
                                        helpText.classList.add("show");
                                    } else {
                                        helpText.classList.remove("show");
                                        helpText.classList.add("hidden");
                                    }
                                });

                                // Attach function to saveButton click event
                                var saveButton = document.getElementById('saveButton');
                                saveButton.addEventListener('click', function() {
                                    if (layer === 'default'){
                                        alert('Error: cannot edit defaults');
                                    } else {
                                        const value = editor.getValue();
                                        function cleanEmptyArrays(json) {
                                            if (Array.isArray(json)) {
                                                return json.filter(item => item !== ""); // Remove empty strings from arrays
                                            } else if (typeof json === "object" && json !== null) {
                                                Object.keys(json).forEach(key => {
                                                    json[key] = cleanEmptyArrays(json[key]); // Recursively clean nested structures
                                                });
                                            }
                                            return json;
                                        }
                                        cleanEmptyArrays(value);
                                        console.log(value)
                                        axios.post('/api/config/layers/' + layer, value)
                                            .then(response => {
                                                // Set cookie named 'message' with the value 'Data saved successfully'
                                                document.cookie = 'message=The layer "' + layer + '" saved successfully. Please restart all nodes using the layer "' + layer + '".; path=/;';
                                                window.location.href = '/pages/config/list/';
                                            })
                                            .catch(error => {
                                                alert('Error saving data:', error);
                                            });
                                    }
                                });

                                // History feature
                                var historyButton = document.getElementById('historyButton');
                                var historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
                                var historyListView = document.getElementById('historyListView');
                                var historyDiffView = document.getElementById('historyDiffView');
                                var diffOutput = document.getElementById('diffOutput');
                                var diffTitle = document.getElementById('diffTitle');

                                if (layer === 'default') {
                                    historyButton.style.display = 'none';
                                }

                                historyButton.addEventListener('click', function() {
                                    historyListView.style.display = 'block';
                                    historyDiffView.style.display = 'none';
                                    historyListView.innerHTML = '<p class="text-muted">Loading history...</p>';
                                    historyModal.show();

                                    axios.get('/api/config/history/' + layer)
                                        .then(function(resp) {
                                            var entries = resp.data;
                                            if (!entries || entries.length === 0) {
                                                historyListView.innerHTML = '<p class="text-muted">No history entries for this layer yet.</p>';
                                                return;
                                            }
                                            var html = '<div class="list-group">';
                                            entries.forEach(function(entry) {
                                                var dt = new Date(entry.changed_at);
                                                var formatted = dt.toLocaleString();
                                                html += '<div class="history-list-item list-group-item list-group-item-action bg-dark text-light" data-id="' + entry.id + '">';
                                                html += '<span>' + formatted + '</span>';
                                                html += '</div>';
                                            });
                                            html += '</div>';
                                            historyListView.innerHTML = html;

                                            historyListView.querySelectorAll('.history-list-item').forEach(function(el) {
                                                el.addEventListener('click', function() {
                                                    var entryId = this.getAttribute('data-id');
                                                    loadHistoryDiff(entryId);
                                                });
                                            });
                                        })
                                        .catch(function(err) {
                                            historyListView.innerHTML = '<p class="text-danger">Failed to load history.</p>';
                                            console.error('Error loading history:', err);
                                        });
                                });

                                document.getElementById('backToHistoryList').addEventListener('click', function() {
                                    historyDiffView.style.display = 'none';
                                    historyListView.style.display = 'block';
                                });

                                function loadHistoryDiff(entryId) {
                                    historyListView.style.display = 'none';
                                    historyDiffView.style.display = 'block';
                                    diffOutput.textContent = 'Loading...';

                                    axios.get('/api/config/history/' + layer + '/' + entryId)
                                        .then(function(resp) {
                                            var entry = resp.data;
                                            var dt = new Date(entry.changed_at);
                                            diffTitle.textContent = 'Change from ' + dt.toLocaleString();
                                            diffOutput.innerHTML = computeDiff(entry.old_config, entry.new_config);
                                        })
                                        .catch(function(err) {
                                            diffOutput.innerHTML = '<span class="text-danger">Failed to load diff.</span>';
                                            console.error('Error loading diff:', err);
                                        });
                                }

                                function computeDiff(oldText, newText) {
                                    var oldLines = oldText.split('\n');
                                    var newLines = newText.split('\n');
                                    var html = '';

                                    // LCS-based unified diff
                                    var m = oldLines.length;
                                    var n = newLines.length;

                                    var dp = [];
                                    for (var i = 0; i <= m; i++) {
                                        dp[i] = [];
                                        for (var j = 0; j <= n; j++) {
                                            if (i === 0 || j === 0) {
                                                dp[i][j] = 0;
                                            } else if (oldLines[i - 1] === newLines[j - 1]) {
                                                dp[i][j] = dp[i - 1][j - 1] + 1;
                                            } else {
                                                dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                                            }
                                        }
                                    }

                                    var result = [];
                                    var i = m, j = n;
                                    while (i > 0 || j > 0) {
                                        if (i > 0 && j > 0 && oldLines[i - 1] === newLines[j - 1]) {
                                            result.unshift({ type: 'context', text: oldLines[i - 1] });
                                            i--; j--;
                                        } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
                                            result.unshift({ type: 'add', text: newLines[j - 1] });
                                            j--;
                                        } else {
                                            result.unshift({ type: 'remove', text: oldLines[i - 1] });
                                            i--;
                                        }
                                    }

                                    result.forEach(function(line) {
                                        var escaped = line.text
                                            .replace(/&/g, '&amp;')
                                            .replace(/</g, '&lt;')
                                            .replace(/>/g, '&gt;');
                                        if (line.type === 'add') {
                                            html += '<div class="diff-line-add">+ ' + escaped + '</div>';
                                        } else if (line.type === 'remove') {
                                            html += '<div class="diff-line-remove">- ' + escaped + '</div>';
                                        } else {
                                            html += '<div class="diff-line-context">  ' + escaped + '</div>';
                                        }
                                    });

                                    return html || '<span class="text-muted">No differences found.</span>';
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching data:', error);
                            });
                    </script>
                </div>
            </div>
        </section>
    </curio-ux>
</body>
</html>