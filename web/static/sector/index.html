<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">

<head>
  <title>Sector List</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  <script type="module" src="/ux/curio-ux.mjs"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.min.css" />
  <script src="https://cdn.datatables.net/2.0.2/js/dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.bootstrap5.min.css" />

  <link rel="stylesheet" href="https://cdn.datatables.net/scroller/2.4.1/css/scroller.dataTables.min.css" />
  <script src="https://cdn.datatables.net/scroller/2.4.1/js/dataTables.scroller.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.1/css/responsive.dataTables.min.css" />
  <script src="https://cdn.datatables.net/responsive/3.0.1/js/dataTables.responsive.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.1/css/buttons.dataTables.min.css" />
  <script src="https://cdn.datatables.net/buttons/3.0.1/js/dataTables.buttons.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/select/2.0.0/css/select.dataTables.min.css" />
  <script src="https://cdn.datatables.net/select/2.0.0/js/dataTables.select.min.js"></script>
  <style>
    th {
      vertical-align: top;
    }
  </style>
</head>

<body style="visibility:hidden" data-bs-theme="dark">
  <curio-ux>
    <section class="section container-fluid">
      <div class="row justify-content-center content">
        <div class="col-md-auto" style="max-width: 95%">
          <table id="sectorTable" class="hover">
            <thead>
              <tr>
                <th></th>
                <th class="dd">SpID</th>
                <th>Sector</th>
                <th>Expiry</th>
                <th class="dd">ðŸ”—</th>
                <th class="dd">Proving</th>
                <th class="dd">HasSealed</th>
                <th class="dd">HasUnsealed</th>
                <th>DealWeight</th>
                <th>Deals</th>
                <th class="dd">Fil+</th>
                <th class="dd">HasSnap</th>
                <th class="dd">Size</th>
                <th class="dd">Flag</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Loading...</td>
              </tr>              
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </curio-ux>
  <script>
    let dt = new DataTable('#sectorTable', {
      processing: true,         // show "processing" indicator
      serverSide: true,         // DataTables will send pagination parameters
      ajax: {
        url: '/api/sector/all',  // match your route
        type: 'POST'
      },
      columns: [
        { title: "", data: null },
        { title: "Miner", data: 'MinerAddress' },
        {
          title: "Sector", data: 'SectorNum',
          render: function (data, type, row) {
            if (type === 'display') {
              return `<a href="/pages/sector/?sp=${row.MinerAddress}&id=${data}">${data}</a>`;
            }
            return data;
          }
        },
        { title: "Expiry", data: 'ExpiresAt' },
        { title: "ðŸ”—", data: 'IsOnChain' },
        { title: "Proving", data: 'Proving' },
        { title: "Has Sealed", data: 'HasSealed' },
        { title: "Has Unsealed", data: 'HasUnsealed' },
        { title: "DealWeight", data: "DealWeight" },
        { title: "Deals", data: "Deals" },
        { title: "Fil+", data: 'IsFilPlus' },
        { title: "Has Snap", data: 'HasSnap' },
        { title: "Size", data: "SealInfo" },
        { title: "Flag", data: "Flag" }
      ],
      select: {
        style: 'multi',
        selector: 'td:first-child',
        items: 'row',
        rows: '%d rows selected',
        headerCheckbox: true,
      },
      columnDefs: [
        {
          orderable: false,
          render: DataTable.render.select(),
          targets: 0
        },
        {
          targets: 13,
          visible: false,
          searchable: false,
        }
      ],
      order: [[13, 'desc'], [1, 'asc'], [2, 'asc']],
      scrollY: window.innerHeight - 250,
      deferRender: true,
      scroller: true,
      // If you still want your "Terminate & Delete" or "Refresh" buttons, you
      // can re-add them, but be aware that with server-side, you won't see all
      // rows at once. Only the current page is selected. That might require
      // different UI logic. Example:
      buttons: [
        {
          extend: 'selected',
          text: 'Terminate & Delete',
          action: function (e, dt, button, config) {
            let selectedRows = dt.rows({ selected: true }).data().toArray();
            let confirmMessage = selectedRows.map(obj => {
              return `Miner: ${obj.MinerAddress}, Sector: ${obj.SectorNum}`;
            }).join(", ");
            if (confirm("Terminate & Delete: " + confirmMessage)) {
              axios.post('/api/sector/terminate', selectedRows)
                      .then(function (response) {
                        console.log(response);
                        document.cookie = "sector_refresh=true; path=/";
                        // Force table reload, so new data is fetched from server
                        dt.ajax.reload(null, false);
                      })
                      .catch(function (error) {
                        console.log(error);
                      });
            }
          }
        },
        {
          text: 'Refresh',
          action: function (e, dt, button, config) {
            document.cookie = "sector_refresh=true; path=/";
            dt.ajax.reload(null, false);
          }
        },
      ]
    });
  </script>
</body>

</html>