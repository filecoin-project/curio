# Dockerfile for testing Supraseal build locally
# Mimics the GitHub Actions Ubuntu 24.04 environment

FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV CUDA_VERSION=13.0
ENV GCC_VERSION=12

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc-12 g++-12 \
    nasm \
    pkg-config \
    autoconf automake libtool \
    libssl-dev \
    libnuma-dev \
    uuid-dev \
    libaio-dev \
    libfuse3-dev \
    libarchive-dev \
    libkeyutils-dev \
    libncurses-dev \
    python3 python3-pip python3-dev \
    curl wget git \
    xxd \
    libconfig++-dev \
    libgmp-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Python build tools
RUN pip3 install --break-system-packages meson ninja pyelftools

# Set up GCC 12 as default
RUN update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100 && \
    update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100 && \
    update-alternatives --set gcc /usr/bin/gcc-12 && \
    update-alternatives --set g++ /usr/bin/g++-12

# Install CUDA Toolkit from NVIDIA Repository
# Source: https://developer.nvidia.com/cuda-downloads?target_os=Linux&target_arch=x86_64&Distribution=Ubuntu&target_version=24.04&target_type=deb_local
RUN wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb && \
    dpkg -i cuda-keyring_1.1-1_all.deb && \
    rm cuda-keyring_1.1-1_all.deb && \
    apt-get update && \
    apt-get -y install cuda-toolkit && \
    ln -sf /usr/local/cuda /usr/local/cuda-13.0 && \
    rm -rf /var/lib/apt/lists/*

# Set up CUDA environment
ENV PATH=/usr/local/cuda/bin:${PATH}
ENV CUDA_HOME=/usr/local/cuda
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:${LD_LIBRARY_PATH}
ENV PIP_BREAK_SYSTEM_PACKAGES=1

# Set working directory
WORKDIR /workspace

# Default command
CMD ["/bin/bash"]

